<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('./partials/meta') %>
    <!-- Favicon -->
    <link rel="shortcut icon" type="image/x-icon" href="/backend/imgs/theme/favicon.svg">
    <!-- Template CSS -->
    <link href="/backend/css/main.css" rel="stylesheet" type="text/css" />
</head>

<body>
    <div class="screen-overlay"></div>
    <%- include('./partials/leftNav') %>
    <main class="main-wrap">
        <%- include('./partials/header') %>
        <section class="content-main">
            <div class="content-header">
                <div>
                    <h2 class="content-title card-title">Products List</h2>
                </div>
                <div>
                    <a href="/admin/dashboard/product/add-product" class="btn btn-primary btn-sm rounded">Add Product</a>
                </div>
            </div>
            <div class="card mb-4">
                <header class="card-header">
                    <div class="row align-items-center">
                        <div class="col col-check flex-grow-0">
                            <div class="form-check ms-2">
                                <input class="form-check-input" type="checkbox" value="" />
                            </div>
                        </div>
                        <div class="col-md-3 col-12 me-auto mb-md-0 mb-3">
                            <select class="form-select">
                                <option selected>All category</option>
                                <!-- Populate categories dynamically if available -->
                            </select>
                        </div>
                        <div class="col-md-2 col-6">
                            <input type="date" value="02.05.2022" class="form-control" />
                        </div>
                        <div class="col-md-2 col-6">
                            <select class="form-select">
                                <option selected>Status</option>
                                <option>Active</option>
                                <option>Disabled</option>
                                <option>Show all</option>
                            </select>
                        </div>
                    </div>
                </header>
                <!-- card-header end// -->
                <div class="card-body">
                    <% products.forEach(product => { %>
                        <article class="itemlist">
                            <div class="row align-items-center">
                                <div class="col col-check flex-grow-0">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" />
                                    </div>
                                </div>
                                <div class="col-lg-4 col-sm-4 col-8 flex-grow-1 col-name">
                                    <a class="itemside" href="/admin/dashboard/product/product-details/<%= product._id %>">
                                        <div class="left">
                                            <img src="/<%= product.images[0] %>" class="img-sm img-thumbnail" alt="Item" />
                                        </div>
                                        <div class="info">
                                            <h6 class="mb-0"><%= product.product_name %></h6>
                                            <p class="text-muted">
                                                Category: <%= product.category ? product.category.name : 'No category' %>
                                            </p>
                                        </div>
                                    </a>
                                </div>
                                <div class="col-lg-2 col-sm-2 col-4 col-price">
                                    <span>$<%= product.price %></span>
                                </div>
                                <div class="col-lg-2 col-sm-2 col-4 col-status">
                                    <span class="badge rounded-pill <%= product.isActive ? 'alert-success' : 'alert-danger' %>">
                                        <%= product.isActive ? 'Active' : 'Disabled' %>
                                    </span>
                                </div>
                                <div class="col-lg-1 col-sm-2 col-4 col-date">
                                    <span><%= product.createdAt ? product.createdAt.toDateString() : 'N/A' %></span>
                                </div>
                                <div class="col-lg-2 col-sm-2 col-4 col-action text-end">
                                    <a href="#" class="btn btn-sm font-sm rounded btn-brand" data-bs-toggle="modal" data-bs-target="#editProductModal" data-id="<%= product._id %>" data-name="<%= product.product_name %>" data-description="<%= product.description %>" data-price="<%= product.price %>" data-stock="<%= product.stock %>">
                                        <i class="material-icons md-edit"></i> Edit
                                    </a>
                                </div>
                            </div>
                            <!-- row .// -->
                        </article>
                    <% }); %>
                </div>
                
                <!-- card-body end// -->
            </div>
            <!-- card end// -->
            <div class="pagination-area mt-30 mb-50">
                <nav aria-label="Page navigation example">
                    <ul class="pagination justify-content-start">
                        <li class="page-item active">
                            <a class="page-link" href="#">01</a>
                        </li>
                        <li class="page-item"><a class="page-link" href="#">02</a></li>
                        <li class="page-item"><a class="page-link" href="#">03</a></li>
                        <li class="page-item">
                            <a class="page-link dot" href="#">...</a>
                        </li>
                        <li class="page-item"><a class="page-link" href="#">16</a></li>
                        <li class="page-item">
                            <a class="page-link" href="#">
                                <i class="material-icons md-chevron_right"></i>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </section>
        <!-- content-main end// -->
        <footer class="main-footer font-xs">
            <div class="row pb-30 pt-15">
                <div class="col-sm-6">
                    <script>
                        document.write(new Date().getFullYear());
                    </script>
                    Â©, GuitMAN - Admin.
                </div>
                <div class="col-sm-6">
                    <div class="text-sm-end">All rights reserved</div>
                </div>
            </div>
        </footer>
    </main>

    <!-- Edit Product Modal -->
    <div id="editProductModal" class="modal fade">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit-product-id">
                    <div class="mb-3">
                        <label for="edit-product-name" class="form-label">Product Name</label>
                        <input type="text" class="form-control" id="edit-product-name" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit-product-description" class="form-label">Description</label>
                        <textarea class="form-control" id="edit-product-description" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="edit-product-price" class="form-label">Price</label>
                        <input type="number" class="form-control" id="edit-product-price" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit-product-stock" class="form-label">Stock</label>
                        <input type="number" class="form-control" id="edit-product-stock" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit-product-category" class="form-label">Category</label>
                        <select class="form-select" id="edit-product-category" required>
                            <% categories.forEach(category => { %>
                                <option value="<%= category._id %>"><%= category.name %></option>
                            <% }); %>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit-product-offer" class="form-label">Offer</label>
                        <select class="form-select" id="edit-product-offer">
                            <option value="">No Offer</option>
                            <% offers.forEach(offer => { %>
                                <option value="<%= offer._id %>"><%= offer.discount %> %</option>
                            <% }); %>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit-product-status" class="form-label">Product Status</label>
                        <select class="form-select" id="edit-product-status" required>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit-product-images" class="form-label">Product Images</label>
                        <input type="file" class="form-control" id="edit-product-images" accept="image/*" multiple onchange="previewImages()">
                    </div>
                    <div id="imagePreview" class="d-flex flex-wrap"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveChangesButton">Save changes</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        function previewImages() {
            const preview = document.querySelector('#imagePreview');
            preview.innerHTML = '';
            const files = document.querySelector('#edit-product-images').files;
            if (files) {
                [].forEach.call(files, readAndPreview);
            }
    
            function readAndPreview(file) {
                if (!/\.(jpe?g|png|gif)$/i.test(file.name)) {
                    return alert(file.name + " is not an image");
                }
    
                const reader = new FileReader();
    
                reader.addEventListener("load", function () {
                    const image = new Image();
                    image.height = 100;
                    image.src = this.result;
                    preview.appendChild(image);
                });
    
                reader.readAsDataURL(file);
            }
        }
        document.addEventListener('DOMContentLoaded', function () {
    $('#editProductModal').on('shown.bs.modal', function (event) {
        const button = $(event.relatedTarget);
            const id = button.data('id');
            const name = button.data('name');
            const description = button.data('description');
            const price = button.data('price');
            const stock = button.data('stock');
            const category = button.data('category');
            const offer = button.data('offer');
            const status = button.data('status');
    
            const modal = $(this);
            modal.find('#edit-product-id').val(id);
            modal.find('#edit-product-name').val(name);
            modal.find('#edit-product-description').val(description);
            modal.find('#edit-product-price').val(price);
            modal.find('#edit-product-stock').val(stock);
            modal.find('#edit-product-category').val(category);
            modal.find('#edit-product-offer').val(offer);
            modal.find('#edit-product-status').val(status);
        const saveButton = document.getElementById('saveChangesButton');
        saveButton.removeEventListener('click', saveChanges); // Remove previous listeners
        saveButton.addEventListener('click', saveChanges);    // Attach new listener
    });

    async function saveChanges() {
        console.log('invoked !!'); // Debug log

        const id = document.getElementById('edit-product-id').value;
        const name = document.getElementById('edit-product-name').value;
        const description = document.getElementById('edit-product-description').value;
        const price = document.getElementById('edit-product-price').value;
        const stock = document.getElementById('edit-product-stock').value;
        const category = document.getElementById('edit-product-category').value;
        const offer = document.getElementById('edit-product-offer').value;
        const status = document.getElementById('edit-product-status').value;
        const images = document.getElementById('edit-product-images').files;

        const formData = new FormData();
        formData.append('id', id);
        formData.append('name', name);
        formData.append('description', description);
        formData.append('price', price);
        formData.append('stock', stock);
        formData.append('category', category);
        formData.append('offer', offer);
        formData.append('status', status);

        for (let i = 0; i < images.length; i++) {
            formData.append('images', images[i]);
        }

        try {
            const response = await fetch(`/admin/dashboard/product/edit-product/${id}`, {
                method: 'PUT',
                body: formData,
            });

            if (response.ok) {
                alert('Product updated successfully!');
                location.reload(); // Reload the page to reflect changes
            } else {
                const error = await response.json();
                alert('Failed to save changes: ' + error.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to save changes');
        }
    }
});
    </script>
    

    <script src="/backend/js/vendors/jquery-3.6.0.min.js"></script>
    <script src="/backend/js/vendors/bootstrap.bundle.min.js"></script>
    <script src="/backend/js/vendors/select2.min.js"></script>
    <script src="/backend/js/vendors/perfect-scrollbar.js"></script>
    <script src="/backend/js/vendors/jquery.fullscreen.min.js"></script>
    <script src="/backend/js/main.js" type="text/javascript"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Toggle submenu
            document.querySelectorAll('.menu-item.has-submenu > a').forEach(item => {
                item.addEventListener('click', function (e) {
                    e.preventDefault();
                    this.parentElement.classList.toggle('active');
                    this.nextElementSibling.classList.toggle('show');
                });
            });

            // Collapse aside menu
            document.querySelector('.btn-aside-minimize').addEventListener('click', function () {
                document.getElementById('offcanvas_aside').classList.toggle('collapsed');
            });
        });
    </script>
</body>
</html>
