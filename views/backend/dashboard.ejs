<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('./partials/meta') %>
    <!-- ˀ -->
    <!-- Favicon -->
    <link
      rel="shortcut icon"
      type="image/x-icon"
      href="/backend/imgs/theme/favicon.svg"
    />

    <!-- Template CSS -->
    <link href="/backend/css/main.css" rel="stylesheet" type="text/css" />
  </head>

  <body class="dark">
    <div class="screen-overlay"></div>
    <%- include('./partials/leftNav') %>
    <main class="main-wrap">
      <%- include('./partials/header') %>
      <section class="content-main">
        <div class="content-header">
          <div>
            <h2 class="content-title card-title">Dashboard</h2>
            <p>Whole data about your business here</p>
          </div>
          <div>
            <a href="#" class="btn btn-primary">
              <i class="text-muted material-icons md-post_add"></i>Create report
            </a>
          </div>
        </div>
        <div class="row">
          <div class="col-lg-3">
            <div class="card card-body mb-4">
              <article class="icontext">
                <span class="icon icon-sm rounded-circle bg-primary-light">
                  <i class="text-primary material-icons md-monetization_on"></i>
                </span>
                <div class="text">
                  <h6 class="mb-1 card-title">Revenue</h6>
                  <span>₹1,13,456.5</span>
                  <span class="text-sm"> Shipping fees are not included </span>
                </div>
              </article>
            </div>
          </div>
          <div class="col-lg-3">
            <div class="card card-body mb-4">
              <article class="icontext">
                <span class="icon icon-sm rounded-circle bg-success-light">
                  <i class="text-success material-icons md-local_shipping"></i>
                </span>
                <div class="text">
                  <h6 class="mb-1 card-title">Orders</h6>
                  <span>53.668</span>
                  <span class="text-sm"> Excluding orders in transit </span>
                </div>
              </article>
            </div>
          </div>
          <div class="col-lg-3">
            <div class="card card-body mb-4">
              <article class="icontext">
                <span class="icon icon-sm rounded-circle bg-warning-light">
                  <i class="text-warning material-icons md-qr_code"></i>
                </span>
                <div class="text">
                  <h6 class="mb-1 card-title">Products</h6>
                  <span>9.856</span>
                  <span class="text-sm"> In 19 Categories </span>
                </div>
              </article>
            </div>
          </div>
          <div class="col-lg-3">
            <div class="card card-body mb-4">
              <article class="icontext">
                <span class="icon icon-sm rounded-circle bg-info-light">
                  <i class="text-info material-icons md-shopping_basket"></i>
                </span>
                <div class="text">
                  <h6 class="mb-1 card-title">Monthly Earning</h6>
                  <span>₹6,55,982</span>
                  <span class="text-sm"> Based in your local time. </span>
                </div>
              </article>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-xl-8 col-lg-12">
            <div class="card mb-4">
              <article class="card-body">
                <h5 class="card-title">Sale statistics</h5>
                <canvas id="myChart" height="120px"></canvas>
              </article>
            </div>
            <div class="row">
              <div class="col-lg-5">
                <div class="card mb-4">
                  <article class="card-body">
                    <h5 class="card-title">New Members</h5>
                    <div class="new-member-list">
                      <div class="d-flex align-items-center justify-content-between mb-4">
                        <div class="d-flex align-items-center">
                          <img src="assets/imgs/people/avatar4.jpg" alt="" class="avatar" />
                          <div>
                            <h6>Patric Adams</h6>
                            <p class="text-muted font-xs">Sanfrancisco</p>
                          </div>
                        </div>
                        <a href="#" class="btn btn-xs">
                          <i class="material-icons md-add"></i> Add
                        </a>
                      </div>
                      <div class="d-flex align-items-center justify-content-between mb-4">
                        <div class="d-flex align-items-center">
                          <img src="assets/imgs/people/avatar2.jpg" alt="" class="avatar" />
                          <div>
                            <h6>Dilan Specter</h6>
                            <p class="text-muted font-xs">Sanfrancisco</p>
                          </div>
                        </div>
                        <a href="#" class="btn btn-xs">
                          <i class="material-icons md-add"></i> Add
                        </a>
                      </div>
                      <div class="d-flex align-items-center justify-content-between mb-4">
                        <div class="d-flex align-items-center">
                          <img src="assets/imgs/people/avatar3.jpg" alt="" class="avatar" />
                          <div>
                            <h6>Tomas Baker</h6>
                            <p class="text-muted font-xs">Sanfrancisco</p>
                          </div>
                        </div>
                        <a href="#" class="btn btn-xs">
                          <i class="material-icons md-add"></i> Add
                        </a>
                      </div>
                    </div>
                  </article>
                </div>
              </div>
              <div class="col-lg-7">
                <div class="card mb-4">
                  <article class="card-body">
                    <h5 class="card-title">Recent activities</h5>
                    <ul class="verti-timeline list-unstyled font-sm">
                      <li class="event-list">
                        <div class="event-timeline-dot">
                          <i class="material-icons md-play_circle_outline font-xxl"></i>
                        </div>
                        <div class="media">
                          <div class="me-3">
                            <h6>
                              <span>Today</span>
                              <i class="material-icons md-trending_flat text-brand ml-15 d-inline-block"></i>
                            </h6>
                          </div>
                          <div class="media-body">
                            <div>Lorem ipsum dolor sit amet consectetur</div>
                          </div>
                        </div>
                      </li>
                      <li class="event-list active">
                        <div class="event-timeline-dot">
                          <i class="material-icons md-play_circle_outline font-xxl animation-fade-right"></i>
                        </div>
                        <div class="media">
                          <div class="me-3">
                            <h6>
                              <span>17 May</span>
                              <i class="material-icons md-trending_flat text-brand ml-15 d-inline-block"></i>
                            </h6>
                          </div>
                          <div class="media-body">
                            <div>Debitis nesciunt voluptatum dicta reprehenderit</div>
                          </div>
                        </div>
                      </li>
                      <li class="event-list">
                        <div class="event-timeline-dot">
                          <i class="material-icons md-play_circle_outline font-xxl"></i>
                        </div>
                        <div class="media">
                          <div class="me-3">
                            <h6>
                              <span>13 May</span>
                              <i class="material-icons md-trending_flat text-brand ml-15 d-inline-block"></i>
                            </h6>
                          </div>
                          <div class="media-body">
                            <div>Accusamus voluptatibus voluptas.</div>
                          </div>
                        </div>
                      </li>
                      <li class="event-list">
                        <div class="event-timeline-dot">
                          <i class="material-icons md-play_circle_outline font-xxl"></i>
                        </div>
                        <div class="media">
                          <div class="me-3">
                            <h6>
                              <span>05 April</span>
                              <i class="material-icons md-trending_flat text-brand ml-15 d-inline-block"></i>
                            </h6>
                          </div>
                          <div class="media-body">
                            <div>At vero eos et accusamus et iusto odio dignissi</div>
                          </div>
                        </div>
                      </li>
                      <li class="event-list">
                        <div class="event-timeline-dot">
                          <i class="material-icons md-play_circle_outline font-xxl"></i>
                        </div>
                        <div class="media">
                          <div class="me-3">
                            <h6>
                              <span>26 Mar</span>
                              <i class="material-icons md-trending_flat text-brand ml-15 d-inline-block"></i>
                            </h6>
                          </div>
                          <div class="media-body">
                            <div>Responded to need “Volunteer Activities</div>
                          </div>
                        </div>
                      </li>
                    </ul>
                  </article>
                </div>
              </div>
            </div>
          </div>
          <div class="col-xl-4 col-lg-12">
            <div class="card mb-4">
              <article class="card-body">
                <h5 class="card-title">Revenue Base on Area</h5>
                <canvas id="myChart2" height="217"></canvas>
              </article>
            </div>
            <div class="card mb-4">
              <article class="card-body">
                <h5 class="card-title">Marketing Chanel</h5>
                <span class="text-muted font-xs">Facebook</span>
                <div class="progress mb-3">
                  <div class="progress-bar" role="progressbar" style="width: 15%">
                    15%
                  </div>
                </div>
                <span class="text-muted font-xs">Instagram</span>
                <div class="progress mb-3">
                  <div class="progress-bar" role="progressbar" style="width: 65%">
                    65%
                  </div>
                </div>
                <span class="text-muted font-xs">Google</span>
                <div class="progress mb-3">
                  <div class="progress-bar" role="progressbar" style="width: 51%">
                    51%
                  </div>
                </div>
                <span class="text-muted font-xs">Twitter</span>
                <div class="progress mb-3">
                  <div class="progress-bar" role="progressbar" style="width: 80%">
                    80%
                  </div>
                </div>
                <span class="text-muted font-xs">Other</span>
                <div class="progress mb-3">
                  <div class="progress-bar" role="progressbar" style="width: 80%">
                    80%
                  </div>
                </div>
              </article>
            </div>
          </div>
        </div>
        <!-- Sales Report Section -->
        <div class="card mb-4">
          <header class="card-header">
            <h4 class="card-title">Sales Report</h4>
          </header>
          <div class="card-body">
            <form id="salesReportForm" method="GET" action="/sales-report">
              <div class="row">
                <div class="col-md-3">
                  <select name="reportType" class="form-select">
                    <option value="">Select Report Type</option>
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="yearly">Yearly</option>
                    <option value="custom">Custom</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <input type="date" name="startDate" class="form-control" placeholder="Start Date" />
                </div>
                <div class="col-md-3">
                  <input type="date" name="endDate" class="form-control" placeholder="End Date" />
                </div>
                <div class="col-md-3">
                  <button type="submit" class="btn btn-primary">Filter and View</button>
                </div>
              </div>
            </form>
            <div class="mt-3">
              <button id="exportPdf" class="btn btn-danger">Export PDF</button>
              <button id="exportExcel" class="btn btn-success">Export Excel</button>
            </div>
            <div class="mt-4" id="salesReportResults">
              <!-- Render filtered sales report results here (via AJAX) -->
            </div>
            <div class="pagination-area mt-30" id="salesReportPagination">
              <!-- Pagination controls will be rendered here -->
            </div>
          </div>
        </div>
        <!-- Latest Orders Section: Display dynamic orders data -->
        <div class="card mb-4">
          <header class="card-header">
            <h4 class="card-title">Latest Orders</h4>
            <div class="row align-items-center">
              <div class="col-md-3 col-12 me-auto mb-md-0 mb-3">
                <div class="custom_select">
                  <select class="form-select select-nice">
                    <option selected>All Categories</option>
                    <option>Women's Clothing</option>
                    <option>Men's Clothing</option>
                    <option>Cellphones</option>
                    <option>Computer & Office</option>
                    <option>Consumer Electronics</option>
                    <option>Jewelry & Accessories</option>
                    <option>Home & Garden</option>
                    <option>Luggage & Bags</option>
                    <option>Shoes</option>
                    <option>Mother & Kids</option>
                  </select>
                </div>
              </div>
              <div class="col-md-2 col-6">
                <input type="date" value="02.05.2022" class="form-control" />
              </div>
              <div class="col-md-2 col-6">
                <div class="custom_select">
                  <select class="form-select select-nice">
                    <option selected>Status</option>
                    <option>All</option>
                    <option>Paid</option>
                    <option>Chargeback</option>
                    <option>Refund</option>
                  </select>
                </div>
              </div>
            </div>
          </header>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table align-middle table-nowrap mb-0">
                <thead class="table-light">
                  <tr>
                    <th scope="col" class="text-center">
                      <div class="form-check align-middle">
                        <input class="form-check-input" type="checkbox" id="transactionCheck01" />
                        <label class="form-check-label" for="transactionCheck01"></label>
                      </div>
                    </th>
                    <th class="align-middle" scope="col">Order ID</th>
                    <th class="align-middle" scope="col">Billing Name</th>
                    <th class="align-middle" scope="col">Date</th>
                    <th class="align-middle" scope="col">Total</th>
                    <th class="align-middle" scope="col">Payment Status</th>
                    <th class="align-middle" scope="col">Payment Method</th>
                    <th class="align-middle" scope="col">View Details</th>
                  </tr>
                </thead>
                <tbody>
                  <% if(orders && orders.length > 0) { %>
                    <% orders.forEach(function(order) { %>
                      <tr>
                        <td class="text-center">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="transactionCheck-<%= order.order_id %>" />
                            <label class="form-check-label" for="transactionCheck-<%= order.order_id %>"></label>
                          </div>
                        </td>
                        <td><a href="#" class="fw-bold"><%= order.order_id %></a></td>
                        <td><%= order.user ? order.user.name : 'N/A' %></td>
                        <td><%= new Date(order.timestamp).toLocaleDateString() %></td>
                        <td>$<%= order.total.toFixed(2) %></td>
                        <td>
                          <% if(order.payment_status === 'paid') { %>
                            <span class="badge badge-pill badge-soft-success">Paid</span>
                          <% } else if(order.payment_status === 'Chargeback') { %>
                            <span class="badge badge-pill badge-soft-danger">Chargeback</span>
                          <% } else if(order.payment_status === 'Refund') { %>
                            <span class="badge badge-pill badge-soft-warning">Refund</span>
                          <% } else { %>
                            <span class="badge badge-pill badge-soft-info"><%= order.payment_status %></span>
                          <% } %>
                        </td>
                        <td>
                          <% if(order.payment_method) { %>
                            <i class="material-icons md-payment font-xxl text-muted mr-5"></i>
                            <%= order.payment_method %>
                          <% } %>
                        </td>
                        <td>
                          <a href="/order/<%= order.order_id %>" class="btn btn-xs">View details</a>
                        </td>
                      </tr>
                    <% }) %>
                  <% } else { %>
                    <tr>
                      <td colspan="8" class="text-center">No orders found</td>
                    </tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <!-- Pagination for orders -->
        <div class="pagination-area mt-30 mb-50">
          <nav aria-label="Page navigation example">
            <ul class="pagination justify-content-start">
              <% for(let i = 1; i <= pagination.totalPages; i++) { %>
                <li class="page-item <%= (pagination.page === i) ? 'active' : '' %>">
                  <a class="page-link" href="?page=<%= i %>&limit=<%= pagination.limit %>"><%= i %></a>
                </li>
              <% } %>
            </ul>
          </nav>
        </div>
      </section>
      <!-- content-main end// -->
      <%- include('./partials/footer') %>
    </main>
    <%- include('./partials/scriptsLinks') %>
    <script>
      // Export button event handlers
      document.getElementById('exportPdf').addEventListener('click', function(){
        const form = document.getElementById('salesReportForm');
        const query = new URLSearchParams(new FormData(form)).toString();
        window.location.href = '/admin/dashboard/export-sales-report/pdf?' + query;
      });
      document.getElementById('exportExcel').addEventListener('click', function(){
        const form = document.getElementById('salesReportForm');
        const query = new URLSearchParams(new FormData(form)).toString();
        window.location.href = '/admin/dashboard/export-sales-report/excel?' + query;
      });

      // Handle Sales Report form submission via AJAX
      document.getElementById('salesReportForm').addEventListener('submit', function(e) {
        e.preventDefault();
        loadSalesReportPage(1);
      });

      function loadSalesReportPage(page) {
  const form = document.getElementById('salesReportForm');
  const queryParams = new URLSearchParams(new FormData(form));
  queryParams.set('page', page);
  fetch('/admin/dashboard/sales-report?' + queryParams.toString())
    .then(response => response.json())
    .then(data => {
      let html = '<h5>Sales Summary</h5>';
      html += `<p>Total Orders: ${data.summary.count}</p>`;
      html += `<p>Total Sales: ₹${data.summary.totalSales.toFixed(2)}</p>`;
      html += `<p>Overall Discount: ₹${data.summary.overallDiscount.toFixed(2)}</p>`;
      html += `<p>Normal Discount: ₹${data.summary.totalNormalDiscount.toFixed(2)}</p>`;
      html += `<p>Coupon Deduction: ₹${data.summary.totalCouponDeduction.toFixed(2)}</p>`;
      if (data.orders && data.orders.length > 0) {
        html += '<table class="table table-bordered"><thead><tr><th>Order ID</th><th>Billing Email</th><th>Date</th><th>Total</th></tr></thead><tbody>';
        data.orders.forEach(order => {
          html += `<tr>
                     <td>${order.order_id}</td>
                     <td>${order.user && order.user.email ? order.user.name : 'N/A'}</td>
                     <td>${new Date(order.timestamp).toLocaleDateString()}</td>
                     <td>₹${order.total.toFixed(2)}</td>
                   </tr>`;
        });
        html += '</tbody></table>';
      } else {
        html += '<p>No sales report data found.</p>';
      }
      document.getElementById('salesReportResults').innerHTML = html;

      // Build pagination for Sales Report
      let paginationHtml = '<nav aria-label="Sales report pagination"><ul class="pagination">';
      for (let i = 1; i <= data.pagination.totalPages; i++) {
        paginationHtml += `<li class="page-item ${data.pagination.page === i ? 'active' : ''}">
                              <a class="page-link" href="#" onclick="loadSalesReportPage(${i}); return false;">${i}</a>
                            </li>`;
      }
      paginationHtml += '</ul></nav>';
      document.getElementById('salesReportPagination').innerHTML = paginationHtml;
    })
    .catch(error => {
      console.error(error);
      document.getElementById('salesReportResults').innerHTML = '<p>Error loading sales report.</p>';
    });
}

    </script>
  </body>
</html>
